// Module included in the following assemblies:
//
// * installing/installing_gcp/installing-gcp-user-infra.adoc
// * installing/installing_gcp/installing-gcp-user-infra-vpc.adoc

ifeval::["{context}" == "installing-gcp-user-infra-vpc"]
:shared-vpc:
endif::[]

[id="installation-creating-gcp-lb_{context}"]
= Creating load balancers in GCP

You must configure load balancers in Google Cloud Platform (GCP) for your
{product-title} cluster to use. One way to create these components is
to modify the provided Deployment Manager template.

[NOTE]
====
If you do not use the provided Deployment Manager template to create your GCP
infrastructure, you must review the provided information and manually create
the infrastructure. If your cluster does not initialize correctly, you might
have to contact Red Hat support with your installation logs.
====

.Prerequisites

* Configure a GCP account.
* Generate the Ignition config files for your cluster.
* Create and configure a VPC and associated subnets in GCP.

.Procedure

. Copy the template from the *Deployment Manager template for the internal load balancer*
section of this topic and save it as `02_lb_int.py` on your computer. This
template describes the internal load balancing objects that your cluster
requires.

. For an external cluster, also copy the template from the *Deployment Manager template for the external load balancer*
section of this topic and save it as `02_lb_ext.py` on your computer. This
template describes the external load balancing objects that your cluster
requires.

. Export the variables that the deployment template uses:

.. Export the cluster network location:
+
ifdef::shared-vpc[]
[source,terminal]
----
$ export CLUSTER_NETWORK=`gcloud compute networks describe ${HOST_PROJECT_NETWORK} --project ${HOST_PROJECT} --account ${HOST_PROJECT_ACCOUNT} --format json | jq -r .selfLink`
----
endif::shared-vpc[]
ifndef::shared-vpc[]
[source,terminal]
----
$ export CLUSTER_NETWORK=`gcloud compute networks describe ${INFRA_ID}-network --format json | jq -r .selfLink`
----
endif::shared-vpc[]

.. Export the control plane subnet location:
+
ifdef::shared-vpc[]
[source,terminal]
----
$ export CONTROL_SUBNET=`gcloud compute networks subnets describe ${HOST_PROJECT_CONTROL_SUBNET} --region=${REGION} --project ${HOST_PROJECT} --account ${HOST_PROJECT_ACCOUNT} --format json | jq -r .selfLink`
----
endif::shared-vpc[]
ifndef::shared-vpc[]
[source,terminal]
----
$ export CONTROL_SUBNET=`gcloud compute networks subnets describe ${INFRA_ID}-master-subnet --region=${REGION} --format json | jq -r .selfLink`
----
endif::shared-vpc[]

.. Export the three zones that the cluster uses:
+
[source,terminal]
----
$ export ZONE_0=`gcloud compute regions describe ${REGION} --format=json | jq -r .zones[0] | cut -d "/" -f9`
----
+
[source,terminal]
----
$ export ZONE_1=`gcloud compute regions describe ${REGION} --format=json | jq -r .zones[1] | cut -d "/" -f9`
----
+
[source,terminal]
----
$ export ZONE_2=`gcloud compute regions describe ${REGION} --format=json | jq -r .zones[2] | cut -d "/" -f9`
----

. Create a `02_infra.yaml` resource definition file:
+
[source,terminal]
----
$ cat <<EOF >02_infra.yaml
imports:
- path: 02_dns.py
- path: 02_lb_ext.py
- path: 02_lb_int.py
resources:
- name: cluster-dns
  type: 02_dns.py
  properties:
    infra_id: '${INFRA_ID}' <1>
    cluster_domain: '${CLUSTER_NAME}.${BASE_DOMAIN}' <2>
    cluster_network: '${CLUSTER_NETWORK}' <3>
- name: cluster-lb-ext
  type: 02_lb_ext.py
  properties:
    infra_id: '${INFRA_ID}'
    region: '${REGION}' <4>
- name: cluster-lb-int
  type: 02_lb_int.py
  properties:
    cluster_network: '${CLUSTER_NETWORK}'
    control_subnet: '${CONTROL_SUBNET}' <5>
    infra_id: '${INFRA_ID}'
    region: '${REGION}'
    zones: <6>
    - '${ZONE_0}'
    - '${ZONE_1}'
    - '${ZONE_2}'
EOF

----
<1> `infra_id` is the `INFRA_ID` infrastructure name from the extraction step.
<2> `cluster_domain` is the domain for the cluster, for example `openshift.example.com`.
<3> `cluster_network` is the `selfLink` URL to the cluster network.
<4> `region` is the region to deploy the cluster into, for example `us-central1`.
<5> `control_subnet` is the URI to the control subnet.
<6> `zones` are the zones to deploy the control plane instances into, like `us-east1-b`, `us-east1-c` and `us-east1-d`.

. Create the deployment by using the `gcloud` CLI:
+
[source,terminal]
----
$ gcloud deployment-manager deployments create ${INFRA_ID}-infra --config 02_infra.yaml
----

. Export the cluster IP address:
+
[source,terminal]
----
$ export CLUSTER_IP=$(gcloud compute addresses describe ${INFRA_ID}-cluster-ip --region=${REGION} --format json | jq -r .address)
----

. For an external cluster, also export the cluster public IP address:
+
[source,terminal]
----
$ export CLUSTER_PUBLIC_IP=$(gcloud compute addresses describe ${INFRA_ID}-cluster-public-ip --region=${REGION} --format json | jq -r .address)
----

ifeval::["{context}" == "installing-gcp-user-infra-vpc"]
:!shared-vpc:
endif::[]
